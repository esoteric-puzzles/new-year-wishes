<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>NewyearWishes</title>
  <base href="/">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/x-icon" href="favicon.ico">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Didact+Gothic&family=Noto+Sans:ital,wght@0,100..900;1,100..900&display=swap"
    rel="stylesheet">
  <link
    href="https://fonts.googleapis.com/css2?family=Didact+Gothic&family=Noto+Sans+SC:wght@100..900&family=Noto+Sans:ital,wght@0,100..900;1,100..900&family=Noto+Serif+SC:wght@200..900&display=swap"
    rel="stylesheet">


  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
</head>

<body>
  <app-root></app-root>

  <script>
    // Default fallback
    // Default fallback (list of IDs)
    let backgroundImages = ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10'];

    async function initializeBackground() {
      try {
        const response = await fetch('assets/image-data.json');
        if (response.ok) {
          const data = await response.json();
          if (data && data.backgrounds && Array.isArray(data.backgrounds)) {
            backgroundImages = data.backgrounds;
          }
        }
      } catch (e) {
        console.warn('Could not load image-data.json, using default background count', e);
      }

      let randomIndex;

      // Check for URL parameter override (for testing)
      const urlParams = new URLSearchParams(window.location.search);
      const bgOverride = urlParams.get('bg');

      if (bgOverride && !isNaN(bgOverride)) {
        // Use the override value (subtract 1 since we add 1 later)
        randomIndex = parseInt(bgOverride) - 1;
      } else {
        // Try to use crypto for truly random selection
        try {
          if (window.crypto && window.crypto.getRandomValues) {
            const randomArray = new Uint32Array(1);
            window.crypto.getRandomValues(randomArray);
            randomIndex = randomArray[0] % backgroundImages.length;
          } else {
            randomIndex = Math.floor(Math.random() * backgroundImages.length);
          }
        } catch (e) {
          randomIndex = Math.floor(Math.random() * backgroundImages.length);
        }
      }

      const imageId = backgroundImages[randomIndex];
      setBackground(imageId);
    }

    // Check if browser supports WebP
    function supportsWebP() {
      const elem = document.createElement('canvas');
      if (!!(elem.getContext && elem.getContext('2d'))) {
        return elem.toDataURL('image/webp').indexOf('data:image/webp') === 0;
      }
      return false;
    }

    const useWebP = supportsWebP();

    // Set background with determined ID
    function setBackground(id) {
      const appRoot = document.querySelector('app-root');
      if (appRoot) {
        // Try WebP first, fallback to PNG
        const webpUrl = `url(assets/images/backgrounds/webp/${id}.webp)`;
        const pngUrl = `url(assets/images/backgrounds/${id}.png)`;

        appRoot.style.backgroundImage = useWebP ? webpUrl : pngUrl;
      } else {
        setTimeout(() => setBackground(id), 10);
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeBackground);
    } else {
      initializeBackground();
    }
  </script>
</body>

</html>